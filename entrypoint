#!/bin/bash

set -euo pipefail
. /.functions

# Update the SSL stuff
init_ssl

require_dir_readable "${CONF_DIR}"
require_dir_readwrite "${LOGS_DIR}"
require_dir_readwrite "${TEMP_DIR}"

JAVA_KEYSTORE_PASSWORD="$(<"${SSL_DIR}/keystore.pass")" || fail "Failed to read the SSL keystore password"
JAVA_TRUSTSTORE_PASSWORD="${JAVA_KEYSTORE_PASSWORD}"

set_or_default JAVA_TOOL_OPTIONS ""

# Require SSL for Zookeeper
JAVA_TOOL_OPTIONS+="-XX:MinRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0"

export TEMP="${TEMP_DIR}"
export TMP="${TEMP_DIR}"

# Check for tika-config.xml (mounted by Helm)
set_or_default TIKA_CONFIG "${CONF_DIR}/tika-config.xml"
if is_file_readable "${TIKA_CONFIG}" ; then
  say "Using Tika configuration: ${TIKA_CONFIG}"
  TIKA_CONF=( --config "${TIKA_CONFIG}" )
else
  say "No Tika configuration found at ${TIKA_CONFIG}, checking server.xml"
  # Fallback to server.xml if it exists
  set_or_default CONF "${CONF_DIR}/server.xml"
  if is_file_readable "${CONF}" ; then
    # TODO: Perform variable expansion in the XML!
    PROCESSED_CONF="${CONF}"
    TIKA_CONF=( --config "${PROCESSED_CONF}" )
  else
    TIKA_CONF=()
  fi
fi

set_or_default LIB_DIR "${BASE_DIR}/lib"
set_or_default CUSTOM_LIB_DIR "${LIB_DIR}/custom"
CP="${LIB_DIR}/*:${CUSTOM_LIB_DIR}/*"
FULL_CLASSPATH="/usr/local/bin/tika-server.jar:${CP}"

# Build module path using wildcards
set_or_default MOD_DIR "${BASE_DIR}/mod"
MP="${MOD_DIR}/*"

say "Starting Tika Server"
say "  Classpath: ${FULL_CLASSPATH}"
say "  Module Path: ${MP}"
say "  Config: ${TIKA_CONF}"
say "  Listening on: *:8443"

CMD=( java -cp "${FULL_CLASSPATH}" -p "${MP}" org.apache.tika.server.core.TikaServerCli --port 8443 --host "*" ${TIKA_CONF} )
execute "${CMD[@]}"
