#!/bin/bash

set -euo pipefail
. /.functions

# Update the SSL stuff
init_ssl

require_dir_readable "${CONF_DIR}"
require_dir_readwrite "${LOGS_DIR}"
require_dir_readwrite "${TEMP_DIR}"

JAVA_KEYSTORE_PASSWORD="$(<"${SSL_DIR}/keystore.pass")" || fail "Failed to read the SSL keystore password"
JAVA_TRUSTSTORE_PASSWORD="${JAVA_KEYSTORE_PASSWORD}"

set_or_default JAVA_TOOL_OPTIONS ""

# Require SSL for Zookeeper
JAVA_TOOL_OPTIONS+="-XX:MinRAMPercentage=50.0 -XX:MaxRAMPercentage=80.0"

export TEMP="${TEMP_DIR}"
export TMP="${TEMP_DIR}"

set_or_default CONF "${CONF_DIR}/server.xml"
if is_file_readable "${CONF}" ; then
	# TODO: Perform variable expansion in the XML!
	PROCESSED_CONF="${CONF}"

	CONF=( --config "${PROCESSED_CONF}" )
else
	CONF=()
fi

set_or_default LIB_DIR "${BASE_DIR}/lib"
CP=""
if is_dir_readable "${LIB_DIR}" ; then
	while read lib ; do
		[ -n "${CP}" ] && CP+=":"
		CP+="$(readlink -f "${lib}")"
	done < <(find "${LIB_DIR}" -mindepth 1 -maxdepth 1 -type f -iname '*.jar' -o -iname '*.zip' | sort)
fi
[ -n "${CP}" ] && CP=(-cp "${CP}") || CP=()

set_or_default MOD_DIR "${BASE_DIR}/mod"
MP=""
if is_dir_readable "${MOD_DIR}" ; then
	while read mod ; do
		[ -n "${MP}" ] && MP+=":"
		MP+="$(readlink -f "${mod}")"
	done < <(find "${MOD_DIR}" -mindepth 1 -maxdepth 1 -type f -iname '*.jar' -o -iname '*.zip' | sort)
fi
[ -n "${MP}" ] && MP=(-p "${MP}") || MP=()

CMD=( java "${CP[@]}" "${MP[@]}" -jar "/usr/local/bin/tika-server.jar" --port 8443 --no-fork --host "*" "${CONF[@]}" )
execute "${CMD[@]}"
